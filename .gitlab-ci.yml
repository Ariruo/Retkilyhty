stages:
  - build
  - test
  - deploy

build_and_push_backend:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - cd backend
    # Use environment variables from GitLab CI/CD settings
    - echo "POSTGRES_DB=$POSTGRES_DB" >> backend.env
    - echo "POSTGRES_USER=$POSTGRES_USER" >> backend.env
    - echo "POSTGRES_PASSWORD=$POSTGRES_PASSWORD" >> backend.env
    - echo "POSTGRES_PORT=$POSTGRES_PORT" >> backend.env
    - echo "POSTGRES_HOST=$POSTGRES_HOST" >> backend.env
    - echo "APPID=$APPID" >> backend.env
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD
  script:
    - docker build -t ariru/trailtorchbackend:latest -f Dockerfile.backend .
    - docker push ariru/trailtorchbackend:latest
  only:
    - main

build_and_push_frontend:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - cd frontend
    # Use environment variables from GitLab CI/CD settings
    - echo "YOUR_FRONTEND_ENV_VARIABLE=$YOUR_FRONTEND_ENV_VALUE" >> frontend.env
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD
  script:
    - docker build -t ariru/trailtorchfrontend:latest -f Dockerfile.frontend .
    - docker push ariru/trailtorchfrontend:latest
  only:
    - main
